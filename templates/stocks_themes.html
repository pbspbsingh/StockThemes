<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ“ˆ</text></svg>">
    <title>Stock Sector Explorer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            height: 100vh;
            overflow: hidden;
            background: #1a1a1a;
        }

        .container {
            display: grid;
            grid-template-columns: 245px 265px 150px 3fr;
            height: 100vh;
            gap: 1px;
            background: #0a0a0a;
        }

        .column {
            background: #1e1e1e;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .column-header {
            position: sticky;
            top: 0;
            background: #2d2d2d;
            color: #e0e0e0;
            padding: 11px 10px;
            font-weight: 600;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            z-index: 10;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .item {
            padding: 8px 10px;
            cursor: pointer;
            border-bottom: 1px solid #2a2a2a;
            transition: all 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: #d0d0d0;
        }

        .item:hover {
            background: #252525;
        }

        .item.selected {
            background: #1a3a52;
            border-left: 3px solid #4a9eff;
        }

        .item-name {
            flex: 1;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 6px;
            min-width: 0;
        }

        .item-name-text {
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
        }

        /* RS pill â€” background/color set dynamically via inline style */
        .item-rs {
            padding: 2px 7px;
            border-radius: 12px;
            font-size: 11px;
            margin-left: 8px;
            flex-shrink: 0;
            font-weight: 600;
            letter-spacing: 0.2px;
        }

        .preview-column {
            background: #1a1a1a;
        }


        .sector-summary {
            padding: 30px;
            color: #d0d0d0;
        }

        .sector-summary h2 {
            color: #4a9eff;
            margin-bottom: 20px;
            font-size: 24px;
        }

        .sector-summary .stat {
            margin: 15px 0;
            font-size: 15px;
        }

        .sector-summary .stat-label {
            color: #888;
            display: inline-block;
            width: 150px;
        }

        .sector-summary .stat-value {
            color: #e0e0e0;
            font-weight: 600;
        }

        .no-items {
            padding: 20px;
            text-align: center;
            color: #666;
            font-size: 13px;
        }

        .preview-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .preview-header #preview-title a {
            color: #4a9eff;
            text-decoration: none;
            transition: color 0.2s;
        }

        .preview-header #preview-title a:hover {
            color: #6ab0ff;
            text-decoration: underline;
        }

        .chart-toggle {
            display: flex;
            gap: 2px;
            background: #1a1a1a;
            border-radius: 4px;
            padding: 2px;
        }

        .chart-toggle button {
            padding: 4px 10px;
            border: none;
            background: transparent;
            color: #888;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            border-radius: 3px;
            transition: all 0.2s;
        }

        .chart-toggle button:hover {
            color: #d0d0d0;
        }

        #chart-toggle { display: none; }

        .chart-toggle button.active {
            background: #4a9eff;
            color: white;
        }

        /* Column headers that need flex layout for clear button */
        .column-header-flex {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* Clear selection button inside column headers */
        .btn-clear {
            display: none;
            padding: 1px 7px;
            font-size: 10px;
            font-weight: 600;
            background: #2a2a2a;
            color: #888;
            border: 1px solid #3a3a3a;
            border-radius: 3px;
            cursor: pointer;
            line-height: 16px;
        }

        .btn-clear:hover {
            color: #d0d0d0;
        }

        /* Preview pane fills remaining height */
        #preview {
            height: 100%;
        }

        /* Stats bar above tables (Sectors N / Industry Groups N / Total Stocks N) */
        .stats-bar {
            display: flex;
            gap: 40px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        /* Overview data table */
        .overview-table {
            width: 100%;
            border-collapse: collapse;
        }

        /* Table header cells */
        .overview-table th {
            padding: 8px 12px;
            border-bottom: 2px solid #4a9eff;
            color: #4a9eff;
            text-align: left;
        }

        .overview-table th.col-rs {
            text-align: center;
            width: 60px;
            border-right: 1px solid #2a2a2a;
        }

        .overview-table th.col-sector {
            width: 160px;
            border-right: 1px solid #2a2a2a;
        }

        .overview-table th.col-industry {
            width: 300px;
            border-right: 1px solid #2a2a2a;
        }

        .overview-table th.col-tickers {
            /* auto width â€” fills remaining space */
        }

        /* Last RS column has no right border */
        .overview-table th.col-rs-last,
        .overview-table td.col-rs-last {
            border-right: none;
        }

        /* Table data cells */
        .overview-table td {
            padding: 8px 12px;
            border-bottom: 1px solid #2a2a2a;
            vertical-align: top;
        }

        .overview-table td.col-sector {
            width: 160px;
            border-right: 1px solid #2a2a2a;
            color: #d0d0d0;
        }

        .overview-table td.col-industry {
            width: 300px;
            border-right: 1px solid #2a2a2a;
            color: #d0d0d0;
        }

        .overview-table td.col-rs {
            border-right: 1px solid #2a2a2a;
            text-align: center;
        }

        .overview-table td.col-tickers {
            line-height: 1.8;
        }

        /* Generic table links â€” hover turns blue */
        .tbl-link {
            color: #d0d0d0;
            text-decoration: none;
        }

        .tbl-link:hover {
            color: #4a9eff;
        }

        .tbl-link-dim {
            color: #c0c0c0;
            text-decoration: none;
        }

        .tbl-link-dim:hover {
            color: #4a9eff;
        }

        /* Small muted count "(N)" in table cells */
        .count {
            color: #666;
            font-size: 11px;
        }

        /* Inline ticker chip in the tickers column */
        .ticker-chip {
            display: inline-flex;
            align-items: center;
            margin: 2px 4px 2px 0;
            white-space: nowrap;
        }

        .ticker-chip-link {
            color: #c0c0c0;
            text-decoration: none;
            font-size: 12px;
        }

        .ticker-chip-link:hover {
            color: #4a9eff;
        }

        .ticker-chip .item-rs {
            margin-left: 3px;
        }

        /* TradingView widget containers */
        .tv-container-split {
            height: 100%;
            width: 100%;
            display: flex;
            flex-direction: column;
        }

        .tv-pane {
            width: 100%;
        }

        .tv-pane-half {
            height: 50%;
        }

        .tv-pane-full {
            height: 100%;
        }
    </style>
</head>

<body>
<div class="container">
    <div class="column">
        <div class="column-header column-header-flex">
            <span>Sectors</span>
            <button id="clear-sectors" class="btn-clear" onclick="AppState.selectedSectors.clear(); AppState.clearIndustrySelection(); Renderers.renderAll();">âœ• clear</button>
        </div>
        <div id="sectors"></div>
    </div>
    <div class="column">
        <div class="column-header column-header-flex">
            <span>Industry Groups</span>
            <button id="clear-industries" class="btn-clear" onclick="AppState.selectedIndustries.clear(); AppState.clearTickerSelection(); Renderers.renderIndustries(); Renderers.renderTickers(); PreviewManager.updatePreview();">âœ• clear</button>
        </div>
        <div id="industries"></div>
    </div>
    <div class="column">
        <div class="column-header">Tickers</div>
        <div id="tickers"></div>
    </div>
    <div class="column preview-column">
        <div class="column-header preview-header">
            <span id="preview-title">Preview</span>
            <div class="chart-toggle" id="chart-toggle">
                <button data-mode="single">D</button>
                <button data-mode="split" class="active">D/W</button>
            </div>
        </div>
        <div id="preview"></div>
    </div>
</div>

<!-- DATA Starts -->
<script id="sector-rs" type="application/json">
    {{ sector_rs|json|safe }}
</script>
<script id="industry-rs" type="application/json">
    {{ industry_rs|json|safe }}
</script>
<script id="stock-rs" type="application/json">
    {{ stock_rs|json|safe }}
</script>
<script id="stock-data" type="application/json">
    {{ summary|json|safe }}
</script>
<!-- DATA Ends -->

<script>
    // ============================================================
    // Data Loader
    // ============================================================

    // Three independent RS lookup maps (lowercase keys for case-insensitive matching)
    const sectorRS = new Map(
        Object.entries(JSON.parse(document.getElementById('sector-rs').textContent))
            .map(([k, v]) => [k.toLowerCase(), v])
    );
    const industryRS = new Map(
        Object.entries(JSON.parse(document.getElementById('industry-rs').textContent))
            .map(([k, v]) => [k.toLowerCase(), v])
    );
    const stockRS = new Map(
        Object.entries(JSON.parse(document.getElementById('stock-rs').textContent))
    );

    const stockData = JSON.parse(document.getElementById('stock-data').textContent);

    // ============================================================
    // STATE MANAGEMENT
    // ============================================================
    const AppState = {
        selectedSectors: new Set(),
        selectedIndustries: new Set(),
        selectedTickerIndex: -1,
        currentTickers: [],

        // Sort sectors: RS descending, fallback to stock count descending
        sortedSectors: [...stockData.sectors].sort((a, b) => {
            const aRS = sectorRS.get(a.name.toLowerCase()) ?? 0;
            const bRS = sectorRS.get(b.name.toLowerCase()) ?? 0;
            if (aRS !== bRS) return bRS - aRS;
            return b.size - a.size;
        }),

        chartMode: 'split',
        currentTickerSymbol: null,

        clearIndustrySelection() {
            this.selectedIndustries.clear();
            this.selectedTickerIndex = -1;
        },

        clearTickerSelection() {
            this.selectedTickerIndex = -1;
        },

        toggleSector(sectorName) {
            if (this.selectedSectors.has(sectorName)) {
                this.selectedSectors.delete(sectorName);
            } else {
                this.selectedSectors.add(sectorName);
            }
            this.clearIndustrySelection();
        },

        toggleIndustry(industryName) {
            if (this.selectedIndustries.has(industryName)) {
                this.selectedIndustries.delete(industryName);
            } else {
                this.selectedIndustries.add(industryName);
            }
            this.clearTickerSelection();
        },

        selectTicker(index) {
            this.selectedTickerIndex = index;
        }
    };

    // ============================================================
    // DOM UTILITIES
    // ============================================================
    const DOM = {
        getElement(id) {
            return document.getElementById(id);
        },

        createElement(tag, className, innerHTML) {
            const element = document.createElement(tag);
            if (className) element.className = className;
            if (innerHTML) element.innerHTML = innerHTML;
            return element;
        },

        clearElement(element) {
            element.innerHTML = '';
        }
    };

    // ============================================================
    // RS COLOR HELPER
    // ============================================================
    function rsColor(rs) {
        if (rs == null) return { bg: '#2a2a2a', fg: '#888' };
        let r, g, b;
        if (rs <= 0.85) {
            r = 180; g = 30; b = 30;
        } else if (rs < 1.0) {
            const t = (rs - 0.85) / 0.15;
            r = Math.round(180 + t * (220 - 180));
            g = Math.round(30  + t * (200 - 30));
            b = 20;
        } else if (rs <= 1.3) {
            const t = (rs - 1.0) / 0.3;
            r = Math.round(220 - t * (220 - 40));
            g = Math.round(200 + t * (210 - 200));
            b = Math.round(20  + t * (80  - 20));
        } else {
            r = 40; g = 210; b = 80;
        }
        return {
            bg: `rgb(${Math.round(r*0.18)},${Math.round(g*0.18)},${Math.round(b*0.18)})`,
            fg: `rgb(${r},${g},${b})`
        };
    }

    // ============================================================
    // HTML TEMPLATES
    // ============================================================
    const Templates = {
        // Dynamically colored RS pill
        rsPill(rs) {
            if (rs == null) return '';
            const { bg, fg } = rsColor(rs);
            return `<span class="item-rs" style="background:${bg};color:${fg};">${rs.toFixed(2)}</span>`;
        },

        // Sidebar row: "Name (count)" + RS pill (used for sectors and industries)
        listItem(name, count, rs) {
            return `<span class="item-name"><span class="item-name-text">${name} (${count})</span></span>${this.rsPill(rs)}`;
        },

        // Ticker row: symbol + RS pill
        tickerItem(ticker, rs) {
            return `<span class="item-name"><span class="item-name-text">${ticker}</span></span>${this.rsPill(rs)}`;
        },

        stat(label, value) {
            return `<div class="stat"><span class="stat-label">${label}:</span><span class="stat-value">${value}</span></div>`;
        }
    };

    // ============================================================
    // SORT HELPERS
    // ============================================================
    function sortByIndustryRS(industries) {
        return [...industries].sort((a, b) => {
            const aRS = industryRS.get(a.name.toLowerCase()) ?? 0;
            const bRS = industryRS.get(b.name.toLowerCase()) ?? 0;
            if (aRS !== bRS) return bRS - aRS;
            return b.size - a.size;
        });
    }

    function sortByStockRS(tickers) {
        return [...tickers].sort((a, b) => {
            const aRS = stockRS.get(a.ticker) ?? 0;
            const bRS = stockRS.get(b.ticker) ?? 0;
            if (aRS !== bRS) return bRS - aRS;
            return a.ticker.localeCompare(b.ticker);
        });
    }

    // ============================================================
    // DATA HELPERS
    // ============================================================
    const DataHelpers = {
        getFilteredIndustries() {
            const industries = [];
            const { sortedSectors, selectedSectors } = AppState;

            sortedSectors.forEach(sector => {
                if (selectedSectors.size === 0 || selectedSectors.has(sector.name)) {
                    sector.industries.forEach(industry => {
                        industries.push({ ...industry, sectorName: sector.name });
                    });
                }
            });

            return sortByIndustryRS(industries);
        },

        getFilteredTickers() {
            const tickers = [];
            const { sortedSectors, selectedSectors, selectedIndustries } = AppState;

            sortedSectors.forEach(sector => {
                const sectorMatch = selectedSectors.size === 0 || selectedSectors.has(sector.name);
                sector.industries.forEach(industry => {
                    const industryMatch = selectedIndustries.size === 0 || selectedIndustries.has(industry.name);
                    if (sectorMatch && industryMatch) {
                        industry.tickers.forEach(ticker => tickers.push(ticker));
                    }
                });
            });

            return sortByStockRS(tickers);
        },

        findTickerInfo(tickerSymbol) {
            for (const sector of AppState.sortedSectors) {
                for (const industry of sector.industries) {
                    const ticker = industry.tickers.find(t => t.ticker === tickerSymbol);
                    if (ticker) {
                        return {
                            sector: sector.name,
                            sectorUrl: sector.url,
                            industry: industry.name,
                            industryUrl: industry.url,
                            ticker: tickerSymbol,
                            exchange: ticker.exchange
                        };
                    }
                }
            }
            return null;
        }
    };

    // ============================================================
    // RENDERERS
    // ============================================================
    const Renderers = {
        renderSectors() {
            const container = DOM.getElement('sectors');
            DOM.clearElement(container);

            const clearBtn = document.getElementById('clear-sectors');
            if (clearBtn) clearBtn.style.display = AppState.selectedSectors.size > 0 ? 'inline-block' : 'none';

            AppState.sortedSectors.forEach(sector => {
                const isSelected = AppState.selectedSectors.has(sector.name);
                const item = DOM.createElement('div', 'item' + (isSelected ? ' selected' : ''));
                const rs = sectorRS.get(sector.name.toLowerCase()) ?? null;
                item.innerHTML = Templates.listItem(sector.name, sector.size, rs);

                item.addEventListener('click', () => {
                    AppState.toggleSector(sector.name);
                    this.renderAll();
                });

                container.appendChild(item);
            });
        },

        renderIndustries() {
            const container = DOM.getElement('industries');
            DOM.clearElement(container);

            const clearBtn = document.getElementById('clear-industries');
            if (clearBtn) clearBtn.style.display = AppState.selectedIndustries.size > 0 ? 'inline-block' : 'none';

            const industries = DataHelpers.getFilteredIndustries();

            if (industries.length === 0) {
                container.innerHTML = '<div class="no-items">No industries found</div>';
                return;
            }

            industries.forEach(industry => {
                const isSelected = AppState.selectedIndustries.has(industry.name);
                const item = DOM.createElement('div', 'item' + (isSelected ? ' selected' : ''));
                const rs = industryRS.get(industry.name.toLowerCase()) ?? null;
                item.innerHTML = Templates.listItem(industry.name, industry.size, rs);

                item.addEventListener('click', () => {
                    AppState.toggleIndustry(industry.name);
                    this.renderIndustries();
                    this.renderTickers();
                    PreviewManager.updatePreview();
                });

                container.appendChild(item);
            });
        },

        renderTickers() {
            const container = DOM.getElement('tickers');
            DOM.clearElement(container);

            const tickers = DataHelpers.getFilteredTickers();
            AppState.currentTickers = tickers;

            if (tickers.length === 0) {
                container.innerHTML = '<div class="no-items">No tickers found</div>';
                AppState.selectedTickerIndex = -1;
                return;
            }

            tickers.forEach((ticker, index) => {
                const isSelected = index === AppState.selectedTickerIndex;
                const item = DOM.createElement('div', 'item' + (isSelected ? ' selected' : ''));
                const rs = stockRS.get(ticker.ticker) ?? null;
                item.innerHTML = Templates.tickerItem(ticker.ticker, rs);

                item.addEventListener('click', () => {
                    if (index === AppState.selectedTickerIndex) {
                        AppState.selectedTickerIndex = -1;
                        this.renderTickers();
                        PreviewManager.updatePreview();
                    } else {
                        AppState.selectTicker(index);
                        this.renderTickers();
                        TradingViewWidget.show(ticker.ticker);
                    }
                });

                container.appendChild(item);
            });
        },

        renderAll() {
            this.renderSectors();
            this.renderIndustries();
            this.renderTickers();
            PreviewManager.updatePreview();
        }
    };

    // ============================================================
    // PREVIEW MANAGER
    // ============================================================
    const PreviewManager = {
        getContainer() {
            return DOM.getElement('preview');
        },

        updateHeader(tickerInfo = null) {
            const titleElement = document.getElementById('preview-title');
            const toggleElement = document.getElementById('chart-toggle');

            if (tickerInfo) {
                titleElement.innerHTML = `<a href="${tickerInfo.sectorUrl}" target="_blank">${tickerInfo.sector}</a> \\ <a href="${tickerInfo.industryUrl}" target="_blank">${tickerInfo.industry}</a> \\ <a href="https://www.tradingview.com/symbols/${tickerInfo.exchange}-${tickerInfo.ticker}/" target="_blank">${tickerInfo.ticker}</a>`;
                toggleElement.style.display = 'flex';
            } else {
                titleElement.textContent = 'Preview';
                toggleElement.style.display = 'none';
            }
        },

        showOverallSummary(sectorsToShow = AppState.sortedSectors) {
            const container = this.getContainer();

            // Count total industry groups across all sectors
            const totalIndustries = sectorsToShow.reduce((sum, s) => sum + s.industries.length, 0);
            const totalStocks = sectorsToShow.reduce((sum, s) => sum + s.size, 0);

            // Build the flat sector â†’ industry rows, sorted by sector RS then industry RS
            const overviewRows = sectorsToShow.flatMap(sector => {
                const sRS = sectorRS.get(sector.name.toLowerCase()) ?? null;
                const { bg: sBg, fg: sFg } = rsColor(sRS);
                const sRSHtml = sRS != null
                    ? `<span class="item-rs" style="background:${sBg};color:${sFg};">${sRS.toFixed(2)}</span>`
                    : 'â€”';

                return sortByIndustryRS(sector.industries).map((ind, idx) => {
                    const iRS = industryRS.get(ind.name.toLowerCase()) ?? null;
                    const { bg: iBg, fg: iFg } = rsColor(iRS);
                    const iRSHtml = iRS != null
                        ? `<span class="item-rs" style="background:${iBg};color:${iFg};">${iRS.toFixed(2)}</span>`
                        : 'â€”';

                    // Only show sector name + RS on first row for that sector
                    const sectorCell = idx === 0
                        ? `<td rowspan="${sector.industries.length}" class="col-sector"><a href="${sector.url}" target="_blank" class="tbl-link">${sector.name}</a> <span class="count">(${sector.size})</span></td>
                           <td rowspan="${sector.industries.length}" class="col-rs">${sRSHtml}</td>`
                        : '';

                    return `<tr>
                        ${sectorCell}
                        <td class="col-industry"><a href="${ind.url}" target="_blank" class="tbl-link-dim">${ind.name}</a> <span class="count">(${ind.size})</span></td>
                        <td class="col-rs col-rs-last">${iRSHtml}</td>
                    </tr>`;
                });
            }).join('');

            container.innerHTML = `
                <div class="sector-summary">
                    <h2>Stock Universe Overview</h2>
                    <div class="stats-bar">
                        ${Templates.stat('Sectors', AppState.sortedSectors.length)}
                        ${Templates.stat('Industry Groups', totalIndustries)}
                        ${Templates.stat('Total Stocks', totalStocks)}
                    </div>
                    <table class="overview-table">
                        <thead>
                            <tr>
                                <th class="col-sector">Sector</th>
                                <th class="col-rs">RS</th>
                                <th class="col-industry">Industry Group</th>
                                <th class="col-rs col-rs-last">RS</th>
                            </tr>
                        </thead>
                        <tbody>${overviewRows}</tbody>
                    </table>
                </div>
            `;
        },

        updatePreview() {
            const { selectedSectors, selectedIndustries, sortedSectors } = AppState;

            AppState.currentTickerSymbol = null;
            this.updateHeader(null);

            if (selectedSectors.size === 0 && selectedIndustries.size === 0) {
                this.showOverallSummary();
                return;
            }

            if (selectedSectors.size === 1 && selectedIndustries.size === 0) {
                const filteredSectors = sortedSectors.filter(s => selectedSectors.has(s.name));
                const allIndustries = sortByIndustryRS(filteredSectors.flatMap(s => s.industries));
                this.showIndustriesOverview(allIndustries);
                return;
            }

            if (selectedSectors.size > 1 && selectedIndustries.size === 0) {
                const filteredSectors = sortedSectors.filter(s => selectedSectors.has(s.name));
                this.showOverallSummary(filteredSectors);
                return;
            }

            if (selectedIndustries.size >= 1) {
                const matchingIndustries = [];
                for (const sector of sortedSectors) {
                    sector.industries.forEach(industry => {
                        if (selectedIndustries.has(industry.name)) {
                            matchingIndustries.push({ ...industry, sectorName: sector.name });
                        }
                    });
                }
                this.showIndustriesOverview(sortByIndustryRS(matchingIndustries));
                return;
            }
        },

        showIndustriesOverview(industries) {
            const container = this.getContainer();
            const totalStocks = industries.reduce((sum, ind) => sum + ind.size, 0);

            const overviewRows = industries.map(ind => {
                const iRS = industryRS.get(ind.name.toLowerCase()) ?? null;
                const { bg: iBg, fg: iFg } = rsColor(iRS);
                const iRSHtml = iRS != null
                    ? `<span class="item-rs" style="background:${iBg};color:${iFg};">${iRS.toFixed(2)}</span>`
                    : 'â€”';

                // Each ticker becomes an inline chip: symbol (RS pill)
                const tickerChips = sortByStockRS(ind.tickers).map(t => {
                    const sRS = stockRS.get(t.ticker) ?? null;
                    const { bg: sBg, fg: sFg } = rsColor(sRS);
                    const sRSHtml = sRS != null
                        ? `<span class="item-rs" style="background:${sBg};color:${sFg};">${sRS.toFixed(2)}</span>`
                        : '';
                    const tvUrl = `https://www.tradingview.com/symbols/${t.exchange}-${t.ticker}/`;
                    return `<span class="ticker-chip"><a href="${tvUrl}" target="_blank" class="ticker-chip-link">${t.ticker}</a>${sRSHtml}</span>`;
                }).join('');

                return `<tr>
                    <td class="col-industry"><a href="${ind.url}" target="_blank" class="tbl-link">${ind.name}</a> <span class="count">(${ind.size})</span></td>
                    <td class="col-rs">${iRSHtml}</td>
                    <td class="col-tickers">${tickerChips}</td>
                </tr>`;
            }).join('');

            container.innerHTML = `
                <div class="sector-summary">
                    <h2>Industry Overview</h2>
                    <div class="stats-bar">
                        ${Templates.stat('Industry Groups', industries.length)}
                        ${Templates.stat('Total Stocks', totalStocks)}
                    </div>
                    <table class="overview-table">
                        <thead>
                            <tr>
                                <th class="col-industry">Industry Group</th>
                                <th class="col-rs">RS</th>
                                <th class="col-tickers">Tickers</th>
                            </tr>
                        </thead>
                        <tbody>${overviewRows}</tbody>
                    </table>
                </div>
            `;
        }
    };

    // ============================================================
    // TRADINGVIEW WIDGET
    // ============================================================
    const TradingViewWidget = {
        show(tickerSymbol) {
            AppState.currentTickerSymbol = tickerSymbol;
            const container = PreviewManager.getContainer();
            const timestamp = Date.now();

            PreviewManager.updateHeader(DataHelpers.findTickerInfo(tickerSymbol));

            if (AppState.chartMode === 'split') {
                this.renderSplitView(container, tickerSymbol, timestamp);
            } else {
                this.renderSingleView(container, tickerSymbol, timestamp);
            }
        },

        renderSplitView(container, tickerSymbol, timestamp) {
            const dailyWidgetId = 'tradingview_daily_' + timestamp;
            const weeklyWidgetId = 'tradingview_weekly_' + timestamp;

            container.innerHTML = `
                    <div class="tradingview-widget-container tv-container-split">
                        <div id="${dailyWidgetId}" class="tv-pane tv-pane-half"></div>
                        <div id="${weeklyWidgetId}" class="tv-pane tv-pane-half"></div>
                    </div>
                `;

            if (!window.TradingView) {
                const script = document.createElement('script');
                script.src = 'https://s3.tradingview.com/tv.js';
                script.onload = () => {
                    this.createWidget(tickerSymbol, dailyWidgetId, 'D');
                    this.createWidget(tickerSymbol, weeklyWidgetId, 'W');
                };
                document.head.appendChild(script);
            } else {
                this.createWidget(tickerSymbol, dailyWidgetId, 'D');
                this.createWidget(tickerSymbol, weeklyWidgetId, 'W');
            }
        },

        renderSingleView(container, tickerSymbol, timestamp) {
            const dailyWidgetId = 'tradingview_daily_' + timestamp;

            container.innerHTML = `
                    <div class="tradingview-widget-container tv-pane tv-pane-full">
                        <div id="${dailyWidgetId}" class="tv-pane tv-pane-full"></div>
                    </div>
                `;

            if (!window.TradingView) {
                const script = document.createElement('script');
                script.src = 'https://s3.tradingview.com/tv.js';
                script.onload = () => {
                    this.createWidget(tickerSymbol, dailyWidgetId, 'D');
                };
                document.head.appendChild(script);
            } else {
                this.createWidget(tickerSymbol, dailyWidgetId, 'D');
            }
        },

        createWidget(tickerSymbol, containerId, interval) {
            const studies = ["MASimple@tv-basicstudies"];
            const studiesOverrides = {
                "moving average.length": 10,
                "moving average.ma.color": interval === "W" ? "#ff922b" : "#5693e7",
            };
            if (interval === 'D') {
                studies.push("STD;MA%Ribbon");
            }

            new TradingView.widget({
                width: "100%",
                height: "100%",
                symbol: tickerSymbol,
                interval: interval,
                timezone: "America/Los_Angeles",
                theme: "dark",
                style: "1",
                locale: "en",
                toolbar_bg: "#1e1e1e",
                enable_publishing: false,
                container_id: containerId,
                studies: studies,
                studies_overrides: studiesOverrides,
                loading_screen: { backgroundColor: "#1e1e1e" }
            });
        }
    };

    // ============================================================
    // KEYBOARD NAVIGATION
    // ============================================================
    const KeyboardNavigation = {
        init() {
            document.addEventListener('keydown', event => this.handleKeyDown(event));
        },

        handleKeyDown(event) {
            if (AppState.currentTickers.length === 0) return;

            if (event.key === 'ArrowDown') {
                event.preventDefault();
                this.navigateNext();
            } else if (event.key === 'ArrowUp') {
                event.preventDefault();
                this.navigatePrevious();
            }
        },

        navigateNext() {
            if (AppState.selectedTickerIndex < AppState.currentTickers.length - 1) {
                AppState.selectedTickerIndex++;
                this.updateView();
            }
        },

        navigatePrevious() {
            if (AppState.selectedTickerIndex > 0) {
                AppState.selectedTickerIndex--;
                this.updateView();
            }
        },

        updateView() {
            Renderers.renderTickers();
            TradingViewWidget.show(AppState.currentTickers[AppState.selectedTickerIndex].ticker);
            this.scrollTickerIntoView();
        },

        scrollTickerIntoView() {
            const container = DOM.getElement('tickers');
            const items = container.querySelectorAll('.item');
            if (items[AppState.selectedTickerIndex]) {
                items[AppState.selectedTickerIndex].scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
        }
    };

    // ============================================================
    // APPLICATION INITIALIZATION
    // ============================================================
    function initializeApp() {
        Renderers.renderAll();
        KeyboardNavigation.init();
        initChartToggle();
    }

    function initChartToggle() {
        const toggleContainer = document.getElementById('chart-toggle');
        const buttons = toggleContainer.querySelectorAll('button');

        buttons.forEach(button => {
            button.addEventListener('click', () => {
                const mode = button.getAttribute('data-mode');
                if (mode === AppState.chartMode) return;

                AppState.chartMode = mode;

                buttons.forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');

                if (AppState.currentTickerSymbol) {
                    TradingViewWidget.show(AppState.currentTickerSymbol);
                }
            });
        });
    }

    initializeApp();
</script>
</body>

</html>
