<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ“ˆ</text></svg>">
    <title>Stock Sector Explorer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            height: 100vh;
            overflow: hidden;
            background: #1a1a1a;
        }

        .container {
            display: grid;
            grid-template-columns: 210px 265px 150px 3fr;
            height: 100vh;
            gap: 1px;
            background: #0a0a0a;
        }

        .column {
            background: #1e1e1e;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .column-header {
            position: sticky;
            top: 0;
            background: #2d2d2d;
            color: #e0e0e0;
            padding: 11px 10px;
            font-weight: 600;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            z-index: 10;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .item {
            padding: 8px 10px;
            cursor: pointer;
            border-bottom: 1px solid #2a2a2a;
            transition: all 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: #d0d0d0;
        }

        .item:hover {
            background: #252525;
        }

        .item.selected {
            background: #1a3a52;
            border-left: 3px solid #4a9eff;
        }

        .item-name {
            flex: 1;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 6px;
            min-width: 0;
        }

        .item-name-text {
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
        }

        .rank-slot {
            width: 28px;
            flex-shrink: 0;
            display: flex;
            justify-content: center;
        }

        .rank {
            font-size: 10px;
            font-weight: 700;
            color: #555;
            background: #2d2d2d;
            border: 1px solid #3a3a3a;
            border-radius: 3px;
            padding: 1px 4px;
            text-align: center;
        }

        .item-size {
            background: #3a3a3a;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            color: #a0a0a0;
            margin-left: 8px;
            flex-shrink: 0;
        }

        .preview-column {
            background: #1a1a1a;
            position: relative;
        }

        .preview-empty {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #666;
            font-size: 14px;
            text-align: center;
            padding: 20px;
        }

        .sector-summary {
            padding: 30px;
            color: #d0d0d0;
        }

        .sector-summary h2 {
            color: #4a9eff;
            margin-bottom: 20px;
            font-size: 24px;
        }

        .sector-summary .stat {
            margin: 15px 0;
            font-size: 15px;
        }

        .sector-summary .stat-label {
            color: #888;
            display: inline-block;
            width: 150px;
        }

        .sector-summary .stat-value {
            color: #e0e0e0;
            font-weight: 600;
        }

        .sector-summary .link-button {
            display: inline-block;
            margin-top: 25px;
            padding: 12px 24px;
            background: #4a9eff;
            color: white;
            text-decoration: none;
            border-radius: 6px;
            font-weight: 600;
            transition: background 0.2s;
        }

        .sector-summary .link-button:hover {
            background: #3a8eef;
        }

        .sector-summary .industries-list,
        .sector-summary .tickers-list {
            margin-top: 25px;
        }

        .sector-summary .industries-list h3,
        .sector-summary .tickers-list h3 {
            color: #4a9eff;
            margin-bottom: 15px;
            font-size: 18px;
        }

        .sector-summary .industry-item {
            padding: 8px 0;
            border-bottom: 1px solid #2a2a2a;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .sector-summary .industry-name {
            color: #d0d0d0;
        }

        .sector-summary .industry-name a {
            color: #4a9eff;
            text-decoration: none;
            transition: color 0.2s;
        }

        .sector-summary .industry-name a:hover {
            color: #6ab0ff;
            text-decoration: underline;
        }

        .sector-summary .industry-size {
            color: #888;
        }

        .sector-summary .ticker-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .sector-summary .ticker-link {
            padding: 8px 12px;
            background: #2a2a2a;
            color: #4a9eff;
            text-decoration: none;
            border-radius: 4px;
            text-align: center;
            transition: all 0.2s;
            font-weight: 500;
        }

        .sector-summary .ticker-link:hover {
            background: #3a3a3a;
            color: #6ab0ff;
        }

        .pie-chart-container {
            margin-top: 30px;
            text-align: center;
        }

        .pie-chart-container h3 {
            color: #4a9eff;
            margin-bottom: 15px;
            font-size: 18px;
        }

        .pie-chart-container canvas {
            max-width: 500px;
            max-height: 500px;
            display: block;
            margin: 0 auto;
        }

        iframe {
            width: 100%;
            height: 100%;
            border: none;
        }

        .no-items {
            padding: 20px;
            text-align: center;
            color: #666;
            font-size: 13px;
        }

        .preview-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chart-toggle {
            display: flex;
            gap: 2px;
            background: #1a1a1a;
            border-radius: 4px;
            padding: 2px;
        }

        .chart-toggle button {
            padding: 4px 10px;
            border: none;
            background: transparent;
            color: #888;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            border-radius: 3px;
            transition: all 0.2s;
        }

        .chart-toggle button:hover {
            color: #d0d0d0;
        }

        .chart-toggle button.active {
            background: #4a9eff;
            color: white;
        }
    </style>
</head>

<body>
<div class="container">
    <div class="column">
        <div class="column-header">Sectors</div>
        <div id="sectors"></div>
    </div>
    <div class="column">
        <div class="column-header">Industry Groups</div>
        <div id="industries"></div>
    </div>
    <div class="column">
        <div class="column-header">Tickers</div>
        <div id="tickers"></div>
    </div>
    <div class="column preview-column">
        <div class="column-header preview-header">
            <span id="preview-title">Preview</span>
            <div class="chart-toggle" id="chart-toggle" style="display:none;">
                <button data-mode="single">D</button>
                <button data-mode="split" class="active">D/W</button>
            </div>
        </div>
        <div id="preview" style="height: 100%;"></div>
    </div>
</div>

<script id="sort-order" type="application/json">{{ sort_order|json|safe }}</script>
<script id="stock-data" type="application/json">{{ summary|json|safe }}</script>

<script>
    // ============================================================
    // Data Loader
    // ============================================================
    const industrySortOrderMap = new Map(JSON.parse(document.getElementById('sort-order').textContent)
        .map((n, i) => [n.toLowerCase(), i]));
    const stockData = JSON.parse(document.getElementById('stock-data').textContent);

    // ============================================================
    // CONFIGURATION
    // ============================================================
    const CONFIG = {
        colors: ['#4a9eff', '#ff6b6b', '#51cf66', '#ffd93d', '#a78bfa', '#ff8787', '#22b8cf', '#ff922b', '#845ef7', '#20c997'],
        pieChart: {
            width: 500,
            height: 500,
            padding: 80,
            labelOffset: 45,
            lineOffset: 25,
            innerRadiusRatio: 0.85,
            legendItemHeight: 20
        },
        fonts: {
            label: 'bold 11px -apple-system, sans-serif',
            legend: '11px -apple-system, sans-serif'
        }
    };

    // ============================================================
    // STATE MANAGEMENT
    // ============================================================
    const AppState = {
        selectedSectors: new Set(),
        selectedIndustries: new Set(),
        selectedTickerIndex: -1,
        currentTickers: [],
        sortedSectors: [...stockData.sectors].sort((a, b) => {
            const fallbackRank = industrySortOrderMap.size;
            const score = (sector) => sector.industries.reduce((sum, ind) => {
                const rank = industrySortOrderMap.get(ind.name.toLowerCase()) ?? fallbackRank;
                return sum + (1 / (rank + 1)) * ind.size;
            }, 0);
            return score(b) - score(a);
        }),
        chartMode: 'split',
        currentTickerSymbol: null,

        clearIndustrySelection() {
            this.selectedIndustries.clear();
            this.selectedTickerIndex = -1;
        },

        clearTickerSelection() {
            this.selectedTickerIndex = -1;
        },

        toggleSector(sectorName) {
            if (this.selectedSectors.has(sectorName)) {
                this.selectedSectors.delete(sectorName);
            } else {
                this.selectedSectors.add(sectorName);
            }
            this.clearIndustrySelection();
        },

        toggleIndustry(industryName) {
            if (this.selectedIndustries.has(industryName)) {
                this.selectedIndustries.delete(industryName);
            } else {
                this.selectedIndustries.add(industryName);
            }
            this.clearTickerSelection();
        },

        selectTicker(index) {
            this.selectedTickerIndex = index;
        }
    };

    // ============================================================
    // DOM UTILITIES
    // ============================================================
    const DOM = {
        getElement(id) {
            return document.getElementById(id);
        },

        createElement(tag, className, innerHTML) {
            const element = document.createElement(tag);
            if (className) element.className = className;
            if (innerHTML) element.innerHTML = innerHTML;
            return element;
        },

        clearElement(element) {
            element.innerHTML = '';
        }
    };

    // ============================================================
    // PIE CHART UTILITIES
    // ============================================================
    const PieChart = {
        setupCanvas(canvas) {
            const dpr = window.devicePixelRatio || 1;
            const { width, height } = CONFIG.pieChart;

            canvas.width = width * dpr;
            canvas.height = height * dpr;
            canvas.style.width = width + 'px';
            canvas.style.height = height + 'px';

            const context = canvas.getContext('2d');
            context.scale(dpr, dpr);

            return context;
        },

        drawSlices(context, data, centerX, centerY, radius) {
            const total = data.reduce((sum, item) => sum + item.size, 0);
            let angle = -Math.PI / 2;

            data.forEach((item, index) => {
                const sliceAngle = (item.size / total) * 2 * Math.PI;

                context.beginPath();
                context.moveTo(centerX, centerY);
                context.arc(centerX, centerY, radius, angle, angle + sliceAngle);
                context.closePath();
                context.fillStyle = CONFIG.colors[index % CONFIG.colors.length];
                context.fill();
                context.strokeStyle = '#1a1a1a';
                context.lineWidth = 2;
                context.stroke();

                angle += sliceAngle;
            });
        },

        drawLabels(context, data, centerX, centerY, radius) {
            const total = data.reduce((sum, item) => sum + item.size, 0);
            const { innerRadiusRatio, lineOffset, labelOffset } = CONFIG.pieChart;
            let angle = -Math.PI / 2;

            data.forEach((item, index) => {
                const sliceAngle = (item.size / total) * 2 * Math.PI;
                const labelAngle = angle + sliceAngle / 2;
                const percentage = (item.size / total) * 100;

                const innerRadius = radius * innerRadiusRatio;
                const outerRadius = radius + lineOffset;
                const labelRadius = radius + labelOffset;

                const innerX = centerX + Math.cos(labelAngle) * innerRadius;
                const innerY = centerY + Math.sin(labelAngle) * innerRadius;
                const outerX = centerX + Math.cos(labelAngle) * outerRadius;
                const outerY = centerY + Math.sin(labelAngle) * outerRadius;
                const labelX = centerX + Math.cos(labelAngle) * labelRadius;
                const labelY = centerY + Math.sin(labelAngle) * labelRadius;

                context.beginPath();
                context.moveTo(innerX, innerY);
                context.lineTo(outerX, outerY);
                context.strokeStyle = CONFIG.colors[index % CONFIG.colors.length];
                context.lineWidth = 1;
                context.stroke();

                context.fillStyle = '#d0d0d0';
                context.font = CONFIG.fonts.label;
                context.textAlign = (labelAngle > Math.PI / 2 || labelAngle < -Math.PI / 2) ? 'right' : 'left';
                context.textBaseline = 'middle';
                context.fillText(`${percentage.toFixed(1)}%`, labelX, labelY);

                angle += sliceAngle;
            });
        },

        drawLegend(context, data, height) {
            const { legendItemHeight } = CONFIG.pieChart;
            let legendY = height - (data.length * legendItemHeight) - 10;

            data.forEach((item, index) => {
                context.fillStyle = CONFIG.colors[index % CONFIG.colors.length];
                context.fillRect(10, legendY, 15, 15);
                context.fillStyle = '#d0d0d0';
                context.font = CONFIG.fonts.legend;
                context.textAlign = 'left';
                context.fillText(item.name, 30, legendY + 10);
                legendY += legendItemHeight;
            });
        },

        draw(canvasId, data) {
            const canvas = DOM.getElement(canvasId);
            if (!canvas) return;

            const context = this.setupCanvas(canvas);
            const { width, height, padding } = CONFIG.pieChart;
            const centerX = width / 2;
            const centerY = height / 2;
            const radius = Math.min(width, height) / 2 - padding;

            this.drawSlices(context, data, centerX, centerY, radius);
            this.drawLabels(context, data, centerX, centerY, radius);
            this.drawLegend(context, data, height);
        }
    };

    // ============================================================
    // HTML TEMPLATES
    // ============================================================
    const Templates = {
        listItem(name, size) {
            return `<span class="item-name"><span class="item-name-text">${name}</span></span><span class="item-size">${size}</span>`;
        },

        industryListItem(name, size, rank) {
            if (industrySortOrderMap.size === 0) {
                return `<span class="item-name">
                            <span class="item-name-text">${name}</span>
                        </span>
                        <span class="item-size">${size}</span>`;
            }

            const rankHtml = rank !== -1 ? `<span class="rank">#${rank   + 1}</span>` : '';
            return `<span class="item-name">
                        <span class="rank-slot">${rankHtml}</span>
                        <span class="item-name-text">${name}</span>
                    </span>
                    <span class="item-size">${size}</span>`;
        },

        tickerItem(ticker) {
            return `<span class="item-name"><span class="item-name-text">${ticker}</span></span>`;
        },

        stat(label, value) {
            return `<div class="stat"><span class="stat-label">${label}:</span><span class="stat-value">${value}</span></div>`;
        },

        linkButton(url, text) {
            return `<a href="${url}" target="_blank" class="link-button">${text} â†—</a>`;
        },

        industryItem(industry) {
            return `<div class="industry-item"><span class="industry-name"><a href="${industry.url}" target="_blank">${industry.name}</a></span><span class="industry-size">${industry.size} stocks</span></div>`;
        },

        tickerLink(ticker) {
            return `<a href="#" class="ticker-link" data-ticker="${ticker}">${ticker}</a>`;
        },

        pieChartSection(title, canvasId) {
            return `<div class="pie-chart-container"><h3>${title}</h3><canvas id="${canvasId}"></canvas></div>`;
        },

        tableRow(name, size) {
            return `<tr><td style="padding:12px;border-bottom:1px solid #2a2a2a;color:#d0d0d0;">${name}</td><td style="padding:12px;border-bottom:1px solid #2a2a2a;color:#d0d0d0;text-align:right;">${size}</td></tr>`;
        },

        dataTable(headers, rows) {
            const headerHtml = headers.map((h, i) =>
                `<th style="padding:12px;border-bottom:2px solid #4a9eff;color:#4a9eff;text-align:${i === 0 ? 'left' : 'right'};">${h}</th>`
            ).join('');
            return `<table style="width:100%;border-collapse:collapse;"><thead><tr>${headerHtml}</tr></thead><tbody>${rows}</tbody></table>`;
        }
    };

    // ============================================================
    // DATA HELPERS
    // ============================================================
    const DataHelpers = {
        getFilteredIndustries() {
            const industries = [];
            const { sortedSectors, selectedSectors } = AppState;

            sortedSectors.forEach(sector => {
                if (selectedSectors.size === 0 || selectedSectors.has(sector.name)) {
                    sector.industries.forEach(industry => {
                        industries.push({ ...industry, sectorName: sector.name });
                    });
                }
            });

            return industries.sort((a, b) => {
                const aIdx = industrySortOrderMap.get(a.name.toLowerCase()) ?? -1;
                const bIdx = industrySortOrderMap.get(b.name.toLowerCase()) ?? -1;
                const aInOrder = aIdx !== -1;
                const bInOrder = bIdx !== -1;

                if (aInOrder && bInOrder) return aIdx - bIdx;
                if (aInOrder) return -1;
                if (bInOrder) return 1;
                return b.size - a.size;
            });
        },

        getFilteredTickers() {
            const tickers = [];
            const { sortedSectors, selectedSectors, selectedIndustries } = AppState;

            sortedSectors.forEach(sector => {
                const sectorMatch = selectedSectors.size === 0 || selectedSectors.has(sector.name);
                sector.industries.forEach(industry => {
                    const industryMatch = selectedIndustries.size === 0 || selectedIndustries.has(industry.name);
                    if (sectorMatch && industryMatch) {
                        industry.tickers.forEach(ticker => tickers.push(ticker));
                    }
                });
            });

            return tickers.sort((a, b) => a.ticker.localeCompare(b.ticker));
        },

        findTickerInfo(tickerSymbol) {
            for (const sector of AppState.sortedSectors) {
                for (const industry of sector.industries) {
                    const ticker = industry.tickers.find(t => t.ticker === tickerSymbol);
                    if (ticker) {
                        return { sector: sector.name, industry: industry.name, ticker: tickerSymbol };
                    }
                }
            }
            return null;
        },

        findSectorByName(name) {
            return AppState.sortedSectors.find(s => s.name === name);
        },

        findIndustryByName(name) {
            for (const sector of AppState.sortedSectors) {
                const industry = sector.industries.find(i => i.name === name);
                if (industry) {
                    return { industry, sectorName: sector.name };
                }
            }
            return null;
        }
    };

    // ============================================================
    // RENDERERS
    // ============================================================
    const Renderers = {
        renderSectors() {
            const container = DOM.getElement('sectors');
            DOM.clearElement(container);

            AppState.sortedSectors.forEach(sector => {
                const isSelected = AppState.selectedSectors.has(sector.name);
                const item = DOM.createElement('div', 'item' + (isSelected ? ' selected' : ''));
                item.innerHTML = Templates.listItem(sector.name, sector.size);

                item.addEventListener('click', () => {
                    AppState.toggleSector(sector.name);
                    this.renderAll();
                });

                container.appendChild(item);
            });
        },

        renderIndustries() {
            const container = DOM.getElement('industries');
            DOM.clearElement(container);

            const industries = DataHelpers.getFilteredIndustries();

            if (industries.length === 0) {
                container.innerHTML = '<div class="no-items">No industries found</div>';
                return;
            }

            industries.forEach(industry => {
                const isSelected = AppState.selectedIndustries.has(industry.name);
                const item = DOM.createElement('div', 'item' + (isSelected ? ' selected' : ''));
                const rank = industrySortOrderMap.get(industry.name.toLowerCase()) ?? -1;
                item.innerHTML = Templates.industryListItem(industry.name, industry.size, rank);

                item.addEventListener('click', () => {
                    AppState.toggleIndustry(industry.name);
                    this.renderIndustries();
                    this.renderTickers();
                    PreviewManager.updatePreview();
                });

                container.appendChild(item);
            });
        },

        renderTickers() {
            const container = DOM.getElement('tickers');
            DOM.clearElement(container);

            const tickers = DataHelpers.getFilteredTickers();
            AppState.currentTickers = tickers;

            if (tickers.length === 0) {
                container.innerHTML = '<div class="no-items">No tickers found</div>';
                AppState.selectedTickerIndex = -1;
                return;
            }

            tickers.forEach((ticker, index) => {
                const isSelected = index === AppState.selectedTickerIndex;
                const item = DOM.createElement('div', 'item' + (isSelected ? ' selected' : ''));
                item.innerHTML = Templates.tickerItem(ticker.ticker);

                item.addEventListener('click', () => {
                    if (index === AppState.selectedTickerIndex) {
                        AppState.selectedTickerIndex = -1;
                        this.renderTickers();
                        PreviewManager.updatePreview();
                    } else {
                        AppState.selectTicker(index);
                        this.renderTickers();
                        TradingViewWidget.show(ticker.ticker);
                    }
                });

                container.appendChild(item);
            });
        },

        renderAll() {
            this.renderSectors();
            this.renderIndustries();
            this.renderTickers();
            PreviewManager.updatePreview();
        }
    };

    // ============================================================
    // PREVIEW MANAGER
    // ============================================================
    const PreviewManager = {
        getContainer() {
            return DOM.getElement('preview');
        },

        updateHeader(tickerInfo = null) {
            const titleElement = document.getElementById('preview-title');
            const toggleElement = document.getElementById('chart-toggle');

            if (tickerInfo) {
                titleElement.textContent = `${tickerInfo.sector} / ${tickerInfo.industry} / ${tickerInfo.ticker}`;
                toggleElement.style.display = 'flex';
            } else {
                titleElement.textContent = 'Preview';
                toggleElement.style.display = 'none';
            }
        },

        showOverallSummary() {
            const container = this.getContainer();
            const tableRows = AppState.sortedSectors.map(s => Templates.tableRow(s.name, s.size)).join('');

            container.innerHTML = `
                    <div class="sector-summary">
                        <h2>Stock Universe Overview</h2>
                        ${Templates.stat('Total Stocks', stockData.size)}
                        ${Templates.stat('Sectors', stockData.sectors.length)}
                        <div style="margin-top:30px;">
                            <h3 style="color:#4a9eff;margin-bottom:15px;font-size:18px;">Sector Breakdown</h3>
                            ${Templates.dataTable(['Sector', 'Stocks'], tableRows)}
                        </div>
                        ${Templates.pieChartSection('Sector Distribution', 'sectorPieChart')}
                    </div>
                `;

            PieChart.draw('sectorPieChart', AppState.sortedSectors);
        },

        showSectorSummary(sector) {
            const container = this.getContainer();
            const sortedIndustries = [...sector.industries].sort((a, b) => b.size - a.size);
            const industriesHtml = sortedIndustries.map(i => Templates.industryItem(i)).join('');

            container.innerHTML = `
                    <div class="sector-summary">
                        <h2>${sector.name}</h2>
                        ${Templates.stat('Total Companies', sector.size)}
                        ${Templates.stat('Industry Groups', sector.industries.length)}
                        ${Templates.linkButton(sector.url, 'View on TradingView')}
                        <div class="industries-list">
                            <h3>Industries in this Sector</h3>
                            ${industriesHtml}
                        </div>
                        ${Templates.pieChartSection('Industry Distribution', 'industryPieChart')}
                    </div>
                `;

            PieChart.draw('industryPieChart', sortedIndustries);
        },

        showMultipleSectorsSummary(sectors) {
            const container = this.getContainer();
            this.updateHeader();

            let allIndustries = [];
            sectors.forEach(sector => {
                sector.industries.forEach(industry => {
                    allIndustries.push({ ...industry, sectorName: sector.name });
                });
            });
            allIndustries.sort((a, b) => b.size - a.size);

            const industriesHtml = allIndustries.map(i => Templates.industryItem(i)).join('');
            const sortedSectors = [...sectors].sort((a, b) => b.size - a.size);

            container.innerHTML = `
                    <div class="sector-summary">
                        <div class="industries-list">
                            <h3>Industry Groups (${allIndustries.length})</h3>
                            ${industriesHtml}
                        </div>
                        <div class="pie-charts-row" style="display:flex;gap:20px;flex-wrap:wrap;margin-top:30px;">
                            ${Templates.pieChartSection('Sector Distribution', 'multiSectorPieChart')}
                            ${Templates.pieChartSection('Industry Distribution', 'multiIndustryPieChart')}
                        </div>
                    </div>
                `;

            PieChart.draw('multiSectorPieChart', sortedSectors);
            PieChart.draw('multiIndustryPieChart', allIndustries);
        },

        showIndustrySummary(industry, sectorName) {
            const container = this.getContainer();
            this.updateHeader();

            const sortedTickers = [...industry.tickers].sort((a, b) => a.ticker.localeCompare(b.ticker));
            const tickersHtml = sortedTickers.map(t => Templates.tickerLink(t.ticker)).join('');

            container.innerHTML = `
                    <div class="sector-summary">
                        <h2>${industry.name}</h2>
                        ${Templates.stat('Sector', sectorName)}
                        ${Templates.stat('Total Stocks', industry.size)}
                        ${Templates.linkButton(industry.url, 'View on TradingView')}
                        <div class="tickers-list">
                            <h3>Stocks in this Industry</h3>
                            <div class="ticker-grid">${tickersHtml}</div>
                        </div>
                    </div>
                `;

            this.attachTickerLinkHandlers(container);
        },

        showMultipleIndustriesSummary(industries) {
            const container = this.getContainer();
            this.updateHeader();

            let allTickers = [];
            industries.forEach(industry => {
                industry.tickers.forEach(ticker => allTickers.push(ticker));
            });
            allTickers.sort((a, b) => a.ticker.localeCompare(b.ticker));

            const tickersHtml = allTickers.map(t => Templates.tickerLink(t.ticker)).join('');
            const sortedIndustries = [...industries].sort((a, b) => b.size - a.size);

            container.innerHTML = `
                    <div class="sector-summary">
                        <div class="tickers-list">
                            <h3>Stocks (${allTickers.length})</h3>
                            <div class="ticker-grid">${tickersHtml}</div>
                        </div>
                        ${Templates.pieChartSection('Industry Group Distribution', 'multiIndustryGroupPieChart')}
                    </div>
                `;

            this.attachTickerLinkHandlers(container);
            PieChart.draw('multiIndustryGroupPieChart', sortedIndustries);
        },

        attachTickerLinkHandlers(container) {
            container.querySelectorAll('.ticker-link').forEach(link => {
                link.addEventListener('click', event => {
                    event.preventDefault();
                    TradingViewWidget.show(event.target.getAttribute('data-ticker'));
                });
            });
        },

        updatePreview() {
            const { selectedSectors, selectedIndustries, sortedSectors } = AppState;

            AppState.currentTickerSymbol = null;
            this.updateHeader(null);

            if (selectedSectors.size === 0 && selectedIndustries.size === 0) {
                this.showOverallSummary();
                return;
            }

            if (selectedSectors.size === 1 && selectedIndustries.size === 0) {
                const sectorName = Array.from(selectedSectors)[0];
                const sector = DataHelpers.findSectorByName(sectorName);
                if (sector) {
                    this.showSectorSummary(sector);
                    return;
                }
            }

            if (selectedSectors.size > 1 && selectedIndustries.size === 0) {
                const filteredSectors = sortedSectors.filter(s => selectedSectors.has(s.name));
                this.showMultipleSectorsSummary(filteredSectors);
                return;
            }

            if (selectedIndustries.size === 1) {
                const industryName = Array.from(selectedIndustries)[0];
                const result = DataHelpers.findIndustryByName(industryName);
                if (result) {
                    this.showIndustrySummary(result.industry, result.sectorName);
                    return;
                }
            }

            if (selectedIndustries.size > 1) {
                let matchingIndustries = [];
                for (const sector of sortedSectors) {
                    sector.industries.forEach(industry => {
                        if (selectedIndustries.has(industry.name)) {
                            matchingIndustries.push({ ...industry, sectorName: sector.name });
                        }
                    });
                }
                this.showMultipleIndustriesSummary(matchingIndustries);
            }
        }
    };

    // ============================================================
    // TRADINGVIEW WIDGET
    // ============================================================
    const TradingViewWidget = {
        show(tickerSymbol) {
            AppState.currentTickerSymbol = tickerSymbol;
            const container = PreviewManager.getContainer();
            const timestamp = Date.now();

            PreviewManager.updateHeader(DataHelpers.findTickerInfo(tickerSymbol));

            if (AppState.chartMode === 'split') {
                this.renderSplitView(container, tickerSymbol, timestamp);
            } else {
                this.renderSingleView(container, tickerSymbol, timestamp);
            }
        },

        renderSplitView(container, tickerSymbol, timestamp) {
            const dailyWidgetId = 'tradingview_daily_' + timestamp;
            const weeklyWidgetId = 'tradingview_weekly_' + timestamp;

            container.innerHTML = `
                    <div class="tradingview-widget-container" style="height:100%;width:100%;display:flex;flex-direction:column;">
                        <div id="${dailyWidgetId}" style="height:50%;width:100%;"></div>
                        <div id="${weeklyWidgetId}" style="height:50%;width:100%;"></div>
                    </div>
                `;

            if (!window.TradingView) {
                const script = document.createElement('script');
                script.src = 'https://s3.tradingview.com/tv.js';
                script.onload = () => {
                    this.createWidget(tickerSymbol, dailyWidgetId, 'D');
                    this.createWidget(tickerSymbol, weeklyWidgetId, 'W');
                };
                document.head.appendChild(script);
            } else {
                this.createWidget(tickerSymbol, dailyWidgetId, 'D');
                this.createWidget(tickerSymbol, weeklyWidgetId, 'W');
            }
        },

        renderSingleView(container, tickerSymbol, timestamp) {
            const dailyWidgetId = 'tradingview_daily_' + timestamp;

            container.innerHTML = `
                    <div class="tradingview-widget-container" style="height:100%;width:100%;">
                        <div id="${dailyWidgetId}" style="height:100%;width:100%;"></div>
                    </div>
                `;

            if (!window.TradingView) {
                const script = document.createElement('script');
                script.src = 'https://s3.tradingview.com/tv.js';
                script.onload = () => {
                    this.createWidget(tickerSymbol, dailyWidgetId, 'D');
                };
                document.head.appendChild(script);
            } else {
                this.createWidget(tickerSymbol, dailyWidgetId, 'D');
            }
        },

        createWidget(tickerSymbol, containerId, interval) {
            const studies = ["MASimple@tv-basicstudies"];
            const studiesOverrides = {
                "moving average.length": 10,
                "moving average.ma.color": interval === "W" ? "#ff922b" : "#5693e7",
            };
            if (interval === 'D') {
                studies.push("STD;MA%Ribbon");
            }

            new TradingView.widget({
                width: "100%",
                height: "100%",
                symbol: tickerSymbol,
                interval: interval,
                timezone: "America/Los_Angeles",
                theme: "dark",
                style: "1",
                locale: "en",
                toolbar_bg: "#1e1e1e",
                enable_publishing: false,
                container_id: containerId,
                studies: studies,
                studies_overrides: studiesOverrides,
                loading_screen: { backgroundColor: "#1e1e1e" }
            });
        }
    };

    // ============================================================
    // KEYBOARD NAVIGATION
    // ============================================================
    const KeyboardNavigation = {
        init() {
            document.addEventListener('keydown', event => this.handleKeyDown(event));
        },

        handleKeyDown(event) {
            if (AppState.currentTickers.length === 0) return;

            if (event.key === 'ArrowDown') {
                event.preventDefault();
                this.navigateNext();
            } else if (event.key === 'ArrowUp') {
                event.preventDefault();
                this.navigatePrevious();
            }
        },

        navigateNext() {
            if (AppState.selectedTickerIndex < AppState.currentTickers.length - 1) {
                AppState.selectedTickerIndex++;
                this.updateView();
            }
        },

        navigatePrevious() {
            if (AppState.selectedTickerIndex > 0) {
                AppState.selectedTickerIndex--;
                this.updateView();
            }
        },

        updateView() {
            Renderers.renderTickers();
            TradingViewWidget.show(AppState.currentTickers[AppState.selectedTickerIndex].ticker);
            this.scrollTickerIntoView();
        },

        scrollTickerIntoView() {
            const container = DOM.getElement('tickers');
            const items = container.querySelectorAll('.item');
            if (items[AppState.selectedTickerIndex]) {
                items[AppState.selectedTickerIndex].scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
        }
    };

    // ============================================================
    // APPLICATION INITIALIZATION
    // ============================================================
    function initializeApp() {
        Renderers.renderAll();
        KeyboardNavigation.init();
        initChartToggle();
    }

    function initChartToggle() {
        const toggleContainer = document.getElementById('chart-toggle');
        const buttons = toggleContainer.querySelectorAll('button');

        buttons.forEach(button => {
            button.addEventListener('click', () => {
                const mode = button.getAttribute('data-mode');
                if (mode === AppState.chartMode) return;

                AppState.chartMode = mode;

                buttons.forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');

                if (AppState.currentTickerSymbol) {
                    TradingViewWidget.show(AppState.currentTickerSymbol);
                }
            });
        });
    }

    initializeApp();
</script>
</body>

</html>